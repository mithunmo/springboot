(function(a){a.fn.multiselect=function(e){var d=a.extend({},a.fn.multiselect.defaults,e||{});return this.filter("select[multiple]:not(.mselect-hidden)").each(function(){var f=a(this).addClass("mselect-hidden").hide(),e=0<f.attr("size")?f.attr("size"):d.size,l="";f.children("option").each(function(b,g){g=a(g);l+=d.item.replace(/%value%/gi,g.val()).replace(/%checked%/i,g.attr("selected")?'checked="checked"':"").replace(/%disabled%/i,g.attr("disabled")?'disabled="disabled"':"").replace(/%label%/gi,g.html())});var c=d.layout.replace(/%items%/gi,l).replace(/%addText%/gi,d.addText).replace(/%cancelText%/gi,d.cancelText).replace(/%inputTitle%/gi,d.inputTitle),c=a(c).insertAfter(this).delegate(":checkbox","change",function(){var b=a(this);f.children('option[value="'+b.val()+'"]').attr("selected",!!b.attr("checked"))}),b=c.is(".mselect-list")?c:c.find(".mselect-list"),m=c.find(".mselect-button-add").click(function(a){a.preventDefault();d.toggleAddButton&&m.hide();j.show();h.focus();h.parents(".mselect-list").length&&b.scrollTop(b.height())}).hover(function(){m.children(".mselect-button-add-icon").toggleClass("ui-state-hover")}),j=c.find(".mselect-input-container"),h=j.find(":text.mselect-input").change(function(){var c=h.val();a.each("function"==typeof d.parse?d.parse(c):[a.trim(c)],function(g,c){var e;c&&!f.children('[value="'+c+'"]').length&&(e=a(d.item.replace(/%value%|%label%/gi,c)).find(":checkbox").attr("checked",!0).end(),b.children(".mselect-list-item").length?b.children(".mselect-list-item:last").after(e):b.prepend(e),f.append('<option value="'+c+'" selected="selected">'+c+"</option>"))});k();b.scrollTop(b.height())}).blur(function(){k()}).bind(a.browser.opera?"keypress":"keydown",function(b){var a=b.keyCode;if(13==a||27==a)b.preventDefault(),13==a?h.change():k()}),n=j.find(".mselect-button-cancel").mousedown(function(){h.val("")}).hover(function(){n.toggleClass("ui-state-hover")}),k=function(){var c=f.children();h.val("");j.hide();m.show();b[b.children().length?"show":"hide"]();c.length>=e&&!b.hasClass("mselect-fixed")&&(b.height(b.children(".mselect-list-item:first").outerHeight(!0)*e).addClass("mselect-fixed"),a.browser.msie&&j.css("margin-right","1em"))};d.itemHoverClass&&b.delegate(".mselect-list-item","hover",function(){a(this).toggleClass(d.itemHoverClass)});k()}).end()};a.fn.multiselect.defaults={layout:'<div class="ui-widget ui-widget-content ui-corner-all mselect mselect-list">%items%<a href="#" class="mselect-button-add"><span class="ui-state-default mselect-button-add-icon"><span class="ui-icon ui-icon-plusthick"/></span>%addText%</a><div class="mselect-input-container"><input type="text" class="ui-widget-content ui-corner-all mselect-input" title="%inputTitle%"/><a href="#" class="ui-state-default mselect-button-cancel" title="%cancelText%"><span class="ui-icon ui-icon-closethick"/></a></div></div>',item:'<div  class="mselect-list-item"><label><input type="checkbox" value="%value%" %checked% %disabled%/>%label%</label></div>',addText:"New value",cancelText:"Cancel",inputTitle:"Separate values by space",size:5,itemHoverClass:"ui-state-hover",toggleAddButton:!1,parse:function(a){return a.split(/\s+/)}}})(jQuery);